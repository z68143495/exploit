<#macro adminPath>/a</#macro>
<#macro assets>/assets</#macro>
<#-- 从script标签中获取js -->
<#macro getJs script>
    <#if script?last_index_of("<") &gt; 0>
        ${script?substring(script?index_of(">") + 1,script?last_index_of("<"))}
    </#if>
</#macro>
<#macro getJson script>
    <#if script?last_index_of("<") &gt; 0>
        <#assign scriptJs>
            ${script?substring(script?index_of(">") + 1,script?last_index_of("<"))}
        </#assign>
        ${scriptJs?js_string}
    </#if>
</#macro>
<#macro getToolJson event name function addClass="">
    {'name': '${name}', 'event': '${event}', 'function':'<@getJson function></@getJson>'}
</#macro>
<#macro getTopJson function function2="" function3="" function4="" function5="">
    [
        '<@getJson function/>'
    <#if function2?has_content>,'<@getJson function2/>'</#if>
    <#if function3?has_content>,'<@getJson function3/>'</#if>
    <#if function4?has_content>,'<@getJson function4/>'</#if>
    <#if function5?has_content>,'<@getJson function5/>'</#if>
    ]
</#macro>
<#macro base content="">
<script>
    layui.config({
        base: '/assets/layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index', "form"], function () {
            <@getJs content/>
    });
</script>
</#macro>
<#macro returnMsg>
else if(res.status == 500){
                                            layer.msg('删除失败，系统错误，请联系管理员', {
                                                    //offset: '15px'
                                                    icon: 5
                                                    , time: 1000
                                            })
                                        }
</#macro>
<#macro iframeSize>
    ['420px', '420px']
</#macro>
<#--
    用于列表页面
    mapping：除根路径的路径名   如：/a/gen/table则需输入/gen/table
    subTool：自定义工具条   用法示例在gen/list页面
 -->
<#macro list mapping subTool="" top="">
    <#if subTool != "">
        <#assign subToolA=subTool?eval/>
    </#if>
    <#if top != "">
        <#assign topA=top?eval/>
    </#if>
    <script>
        layui.config({
            base: '/assets/layuiadmin/' //静态资源所在路径
        }).extend({
            index: 'lib/index' //主入口模块
        }).use(['index', 'table', 'form'], function () {
            var table = layui.table;
            var $ = layui.$;
            var form = layui.form;
            //监听搜索
            form.on('submit(search)', function (data) {
                var field = data.field;

                //执行重载
                table.reload('table', { //绑定数据表格的id
                    where: field
                });
            });
            //监听工具条
            table.on('tool(table)', function (obj) { //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
                var data = obj.data; //获得当前行数据
                var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
                var tr = obj.tr; //获得当前行 tr 的DOM对象

                var id = data.id; //获得当前行 tr 的id

            if (layEvent === 'detail')
            { //查看

            }
            else if (layEvent === 'del')
            { //删除
                layer.confirm('确定删除吗？', function (index) {
                    obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                    layer.close(index);
                    //向服务端发送删除指令
                    layui.admin.req({
                        url: '<@adminPath/>${mapping}/delete'
                        , data: {id: id}
                        , done: function (res) {
                            if (res.code == 0) {
                                layer.msg('已删除', {
                                    //offset: '15px'
                                    icon: 1
                                    , time: 1000
                                })

                                table.reload('table'); //数据刷新
                                layer.close(index); //关闭弹层
                            } else {
                                layer.msg('删除失败', {
                                    //offset: '15px'
                                    icon: 5
                                    , time: 1000
                                })
                            }
                        }

                    });
                });
            }
            else if (layEvent === 'edit')
            { //编辑
                // 弹出层
                layer.open({
                    type: 2
                    , title: '编辑'
                    , content: '<@adminPath/>${mapping}/form?id=' + id
                    , maxmin: true
                    ,area: <@iframeSize/>
                    , btn: ['保存', '取消']
                    , yes: function (index, layero) {
                        var iframeWindow = window['layui-layer-iframe' + index]
                                , submitID = 'submit'
                                , submit = layero.find('iframe').contents().find('#' + submitID);

                        //监听提交
                        iframeWindow.layui.form.on('submit(' + submitID + ')', function (data) {
                            var field = data.field; //获取提交的字段
                            // alert(field.id);
                            layui.admin.req({
                                type: "POST"
                                , url: '<@adminPath/>${mapping}/save' //实际使用请改成服务端真实接口
                                , data: field
                                , done: function (res) {
                                    //必须返回code:0
                                    if (res.code == 0) {
                                        layer.msg("编辑成功！", {
                                            // offset: '15px'
                                            icon: 1
                                            , time: 1000
                                        })
                                        table.reload('table'); //数据刷新
                                        layer.close(index); //关闭弹层
                                    } else {
                                        layer.msg("编辑失败！", {icon: 5})
                                    }
                                }
                            })

                        });
                        submit.trigger('click');
                    }
                });
            }
            // 添加自定义工具栏
                <#if subTool != "">
                    <#if subToolA?size &gt; 0>
                        <#list subToolA as tool>
                        else if (layEvent === "${tool.event}") {
                            ${tool.function}
                        }
                        </#list>
                    </#if>
                </#if>
            });
            //事件准备
            $('.layui-btn.layuiadmin-btn').on('click', function () {
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
            //事件
            var active = {
                batchDel: function () {
                    var checkStatus = table.checkStatus('table')
                            , checkData = checkStatus.data; //得到选中的数据

                    if (checkData.length === 0) {
                        return layer.msg('请选择数据');
                    }

                    var ids = [];
                    for (var i = 0; i < checkData.length; i++) {
                        ids.push(checkData[i].id);
                    }

                    layer.confirm('确定删除吗？', function (index) {

                        //执行 Ajax 后重载
                        layui.admin.req({
                            url: '<@adminPath/>${mapping}/batchDelete'
                            , data: {ids: ids.toString()}
                            , done: function (res) {
                                if (res.code == 0) {
                                    layer.msg('已删除', {
                                        //offset: '15px'
                                        icon: 1
                                        , time: 1000
                                    })

                                    table.reload('table'); //数据刷新
                                    layer.close(index); //关闭弹层
                                } else {
                                    layer.msg('删除失败', {
                                        //offset: '15px'
                                        icon: 5
                                        , time: 1000
                                    })
                                }
                            }

                        });

                    });

                },
                add: function () {
                    layer.open({
                        type: 2
                        , title: '添加'
                        , content: '<@adminPath/>${mapping}/form'
                        , maxmin: true
                        , area: <@iframeSize/>
                        , btn: ['确定', '取消']
                        , yes: function (index, layero) {
                            var iframeWindow = window['layui-layer-iframe' + index]
                                    , submitID = 'submit'
                                    , submit = layero.find('iframe').contents().find('#' + submitID);

                            //监听提交
                            iframeWindow.layui.form.on('submit(' + submitID + ')', function (data) {
                                var field = data.field; //获取提交的字段
                                //处理一个数据
                                field.status = field.status == undefined ? "0" : "1";
                                layui.admin.req({
                                    type: "POST"
                                    , url: '<@adminPath/>${mapping}/save' //实际使用请改成服务端真实接口
                                    , data: field
                                    , done: function (res) {
                                        //必须返回code:0
                                        if (res.status == 0) {
                                            layer.msg("添加成功！", {
                                                // offset: '15px'
                                                icon: 1
                                                , time: 1000
                                            })
                                            table.reload('table'); //数据刷新
                                            layer.close(index); //关闭弹层
                                        } <@returnMsg/>
                                        else {
                                            layer.msg("添加失败！", {icon: 5})
                                        }
                                    }
                                })

                            });
                            submit.trigger('click');
                        }
                    });
                }
                <#if top != "">
                    <#list topA as t>
                    ,${t}
                    </#list>
                </#if>
            };
        });
    </script>
    <script type="text/html" id="toolbar">
        <a class="layui-btn layui-btn-xs" lay-event="detail">查看</a>
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
        <#--添加自定义工具栏-->
        <#if subTool != "">
            <#if subToolA?size &gt; 0>
                <#list subToolA as tool>
        <a class="layui-btn ${tool.addClass!} layui-btn-xs" lay-event="${tool.event!}">${tool.name!}</a>
                </#list>
            </#if>
        </#if>
    </script>
</#macro>